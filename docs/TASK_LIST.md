# タスクリスト機能ドキュメント

## 概要

LightList はタスクリスト管理機能を提供しており、複数のタスクリストを作成・管理できます。各タスクリストは個別のタスクを含み、ユーザーが効率的に作業を管理できるように設計されています。

## タスク管理ページ（統合ドロワーレイアウト）

**ページ:** `src/pages/app.tsx`

### 概要

タスク管理ページは、タスクリスト一覧とタスク詳細を統合したドロワーレイアウトで表示します。モバイルではオーバーレイドロワー、デスクトップでは2カラムレイアウトで表示され、シームレスなタスク管理体験を提供します。

### レイアウト仕様

#### モバイル（< 768px）

- **サイドバー:** オーバーレイドロワー（左からスライドイン）
  - ハンバーガーメニューボタンで開閉
  - スワイプジェスチャーで開閉（右スワイプで開く、左スワイプで閉じる）
  - タスクリスト選択後は自動で閉じる
  - 半透明背景で画面を覆う

#### デスクトップ（>= 768px）

- **レイアウト:** 固定サイドバー（w-80 / 320px）+ メインコンテンツ
- **サイドバー:** 常に表示、開閉機能なし
- **ハンバーガーメニュー:** 非表示

### 主要機能

#### 1. タスクリスト一覧表示（サイドバー）

**仕様:**

- 縦並びリスト形式でタスクリストを表示
- 各リスト項目は以下の情報を表示：
  - 背景色インジケータ（上部の色付きバー）
  - リスト名（切り詰め表示対応）
  - タスク数
- リスト項目はホバー時に視覚的フィードバック

**選択状態:**

- 現在選択中のリストは `ring-2 ring-indigo-500` で視覚化
- リスト項目クリックで選択（メインエリアにタスク一覧を表示）

**エラーハンドリング:**

- 認証されていないユーザーはリダイレクト処理により、`/` へ移動
- リスト読み込み中の状態をローディング表示で表現

#### 2. スワイプジェスチャー対応（モバイルのみ）

**スワイプ操作:**

- **右スワイプ:** メインエリアから右にスワイプするとドロワーが開く
- **左スワイプ:** ドロワーから左にスワイプするとドロワーが閉じる
- **スクロール保護:** `preventScrollOnSwipe: true` でスクロール操作との競合を回避

**技術実装:**

- ライブラリ: `react-swipeable`
- `trackMouse: false` でマウスでのスワイプを無効化（デスクトップ向け）

#### 3. 空の状態表示（サイドバー）

**表示条件:**

タスクリストが存在しない場合、サイドバーに以下を表示：

- "タスクリストがありません" メッセージ
- 新規作成ボタン

**メイン エリア:**

- タスクリストが選択されていない場合は、空の状態メッセージと新規作成ボタンを表示

#### 4. 新規作成機能

**ページレイアウト:**

- 一覧下部に「新規作成」ボタンを配置
- 空の状態でも「新規作成」ボタンを表示可能

**モーダルフォーム:**

1. ボタンをクリックするとモーダルフォームが表示される
2. リスト名入力フィールドと確認ボタンを提供
3. 以下の操作をサポート：
   - **テキスト入力:** リスト名の入力
   - **Enter キー:** フォーム送信のショートカット（`creatingList` が false の場合）
   - **キャンセルボタン:** モーダルを閉じて入力をクリア
   - **作成ボタ:** 新規リストを作成

**処理フロー:**

```
1. ユーザーが「新規作成」ボタンをクリック
   ↓
2. モーダルフォーム表示
   ↓
3. リスト名を入力（検証：空白は不可）
   ↓
4. 「作成」ボタンをクリック
   ↓
5. `createTaskList(name)` 関数を呼び出し
   ↓
6. Firestore にリストを作成
   ↓
7. ストアを更新（自動的に画面に反映）
   ↓
8. モーダルを閉じて、入力をリセット
```

**エラーハンドリング:**

- 作成中にエラーが発生した場合、エラーメッセージを表示
- ユーザーは同じモーダル内で再度試行可能

#### 4. タスクリストの並び替え（ドラッグ&ドロップ）

**機能:**

各タスクリストカードの左側にあるドラッグハンドル（≡アイコン）をドラッグして、リストの順序を変更できます。

**ユーザー操作:**

1. ドラッグハンドルをマウスで押下（ポインタ感度: 8px）
2. マウスを上下・左右に移動してリストの順序を変更
3. マウスボタンを放すと新しい順序が保存される

**キーボード操作:**

- `arrow-up/down` キーでもドラッグハンドルをフォーカス後に順序変更が可能（アクセシビリティ対応）

**処理フロー:**

```
1. ユーザーがドラッグハンドルをドラッグ開始
   ↓
2. ドラッグ中はカードが半透明表示
   ↓
3. ドラッグ終了時にドラッグされたリストと対象リストを特定
   ↓
4. 浮動小数 order を使用して新しい order 値を計算
   ↓
5. `updateTaskListOrder(draggedTaskListId, targetTaskListId)` を呼び出し
   ↓
6. 必要に応じて reindex を実行
   ↓
7. Firestore を更新（トランザクション使用）
   ↓
8. ストアが更新され、自動的に画面に反映
```

**視覚的フィードバック:**

- ドラッグハンドルはホバー時に色が濃くなる（`hover:text-gray-600`）
- ドラッグ中のカードは半透明表示（`opacity-50`）
- ドラッグハンドルは `cursor-grab` から `cursor-grabbing` に変更

**技術詳細:**

- ライブラリ: `@dnd-kit/core` と `@dnd-kit/sortable` を使用
- ポインタセンサーとキーボードセンサーの両方に対応
- 最も近い衝突検出アルゴリズムを使用（`closestCenter`）
- グリッドレイアウトに対応

## 状態管理

### ページレベルの状態

```typescript
// ドロワーとタスクリスト選択状態
const [isDrawerOpen, setIsDrawerOpen] = useState(false);
const [selectedTaskListId, setSelectedTaskListId] = useState<string | null>(
  null,
);

// タスクリスト作成
const [showCreateListForm, setShowCreateListForm] = useState(false);
const [createListInput, setCreateListInput] = useState("");
const [creatingList, setCreatingList] = useState(false);

// タスク操作状態（メインコンテンツ内）
const [editingTaskId, setEditingTaskId] = useState<string | null>(null);
const [editingTaskText, setEditingTaskText] = useState("");
const [newTaskText, setNewTaskText] = useState("");
const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
const [showEditColorModal, setShowEditColorModal] = useState(false);
const [editingColor, setEditingColor] = useState("");
const [showShareModal, setShowShareModal] = useState(false);
```

**ドロワー状態の詳細:**

- `isDrawerOpen`: モバイルでドロワーが開いている状態
  - モバイル（< 768px）: クリック/スワイプで動的に変更
  - デスクトップ（>= 768px）: 常に false（常時表示）

- `selectedTaskListId`: 現在選択中のタスクリスト ID
  - マウント時に自動的に最初のリストを選択
  - リスト項目クリックで変更
  - モバイルでの選択時に自動的にドロワーが閉じる

### アプリケーション状態（Store）

タスクリストデータは `appStore` から取得されます：

```typescript
const state: AppState = {
  user: User | null,
  settings: Settings | null,
  taskLists: TaskList[]  // 順序付きリスト
};
```

## API インターフェース

### createTaskList(name: string, background?: string): Promise<string>

新しいタスクリストを作成します。

**パラメータ:**

- `name`: タスクリスト名（必須）
- `background`: 背景色（オプション、デフォルト: `"#ffffff"`）

**戻り値:**

- 作成されたタスクリスト ID

**動作:**

1. ローカルストアを楽観的に更新
2. Firestore に新規リストドキュメントを作成
3. `taskListOrder` に新規リストの順序情報を追加
4. `updatedAt` タイムスタンプを自動設定
5. ストアの変更をリスナーに通知

**例外:**

- Firebase Firestore のエラーをスロー
- ユーザーログイン状態を確認し、ログインしていない場合はエラーをスロー

### updateTaskListOrder(draggedTaskListId: string, targetTaskListId: string): Promise<void>

タスクリストの順序を更新します（ドラッグ&ドロップ時）。

**パラメータ:**

- `draggedTaskListId`: ドラッグされたタスクリスト ID
- `targetTaskListId`: ドロップ先のタスクリスト ID（この位置に移動）

**例:**

```typescript
await updateTaskListOrder("list-id-1", "list-id-3");
// list-id-1 が list-id-3 の位置に移動（list-id-3 より下へ移動する場合は直後に配置）
```

**動作:**

1. 現在の order を昇順で取得し、ドラッグ対象を配列から一度除外
2. 対象リストの位置にドラッグ対象を挿入し（上方向は直前、下方向は直後）、1 からの連番で再採番
3. Firestore の `taskListOrder` ドキュメントをまとめて更新し、`updatedAt` を設定
4. ストアの変更をリスナーに通知

**技術仕様：**

- **order フィールド:** 1.0 からの連番
- **更新範囲:** 並び替え後の全リストに対して order を再採番
- **更新方法:** Firestore の単一アップデートで一括反映

**例外:**

- Firebase Firestore のエラーをスロー
- 指定されたタスクリストが見つからない場合はエラーをスロー

## 翻訳キー

タスクリスト機能の UI テキストは i18next を使用して多言語対応されています。

**メッセージキー:**

```
app:
  title: タスクページのタイトル（"タスク" / "Tasks"）
  emptyState: タスクリストがない状態のメッセージ
  createNew: 新規作成ボタンのテキスト
  createTaskList: モーダルタイトル
  taskListName: リスト名入力フィールドのラベル
  taskListNamePlaceholder: 入力フィールドのプレースホルダー
  create: 作成ボタンのテキスト
  creating: 作成中の状態表示テキスト
  cancel: キャンセルボタンのテキスト
  error: エラーメッセージ（汎用）
  moveUp: 上へ移動ボタンのテキスト
  moveDown: 下へ移動ボタンのテキスト
```

詳細は `locales/ja.json` および `locales/en.json` を参照してください。

## デザイン仕様

### タスクリストカード

- **背景:** 白色（`bg-white`）
- **シャドウ:** 標準シャドウ（`shadow`）、ホバー時に強調（`hover:shadow-lg`）
- **コーナー:** 丸角（`rounded-lg`）
- **上部ボーダー:** 4px の色付きボーダー（背景色を視覚化）
- **内部構造:**
  - ドラッグハンドル、リスト情報が横方向に配置
  - パディング中程度（`p-4`）
  - ドラッグハンドルは flex-shrink-0 で幅固定
- **ホバー効果:**
  - シャドウ増加（`shadow-lg`）
  - スムーズなトランジション（`transition-all`）
- **ドラッグ中:**
  - 半透明表示（`opacity-50`）

### ドラッグハンドル

- **アイコン:** ≡ アイコン（6ドット）
- **色:** グレー（`text-gray-400`）
- **ホバー色:** より濃いグレー（`hover:text-gray-600`）
- **カーソル:** `cursor-grab` / `cursor-grabbing`

### モーダルフォーム

- **背景オーバーレイ:** 半透明黒（`bg-black bg-opacity-50`）
- **フォーム背景:** 白色（`bg-white`）
- **最大幅:** 中程度（`max-w-sm`）
- **パディング:** 中程度（`p-6`）
- **入力フィールド:** ボーダースタイル、フォーカス時はインディゴリング

### 色スキーム

- **プライマリアクション:** インディゴ（`bg-indigo-600`）
- **キャンセル:** グレー（`bg-gray-300`）
- **エラー:** 赤（`bg-red-50` / `text-red-700`）
- **ホバー:** より濃い色へ遷移

## 順序管理

- タスクリスト・タスクともに並び替え後は 1.0 からの連番で order を再採番します。
- 並び替えは昇順に並べ替えた配列を再構成し、Firestore へまとめて反映します。
- 追加時も挿入位置を確定してから全体を再採番するため、挿入位置がずれません。

## パフォーマンス考慮事項

### 最適化

1. **グリッドレスポンシブ:** Tailwind CSS ブレークポイントで効率的に実装
2. **リスト表示:** React の `map` で効率的にレンダリング
3. **状態更新:** 必要な状態変更のみトリガー
4. **order 更新:** 浮動小数により、並び替え時の更新件数を最小化

### 注意点

- リストが大量の場合、仮想スクロール導入を検討
- タスク数が多い場合、ページングを検討
- 非常に多くの並び替え操作が発生する場合、reindex 実行をモニタリング

## トラブルシューティング

### タスクリストが表示されない

1. ユーザーがログインしているか確認
2. Firebase の認証状態が正しいか確認
3. Firestore のデータ構造が正しいか確認
4. ブラウザの開発者ツールでコンソールエラーを確認

### 新規作成ができない

1. インターネット接続を確認
2. Firebase のセキュリティルールを確認（書き込み権限があるか）
3. リスト名が空でないか確認
4. ローディング状態が正しくリセットされているか確認

### モーダルが閉じない

1. キャンセルボタンをクリック
2. ブラウザを刷新してセッションをリセット

## メインコンテンツエリア（タスク詳細表示）

### 概要

メインコンテンツエリアは、統合ドロワーレイアウトの右側に表示される領域です。サイドバーで選択されたタスクリスト内のすべてのタスクを表示・管理します。タスクの作成、編集、削除、完了状態の切り替え、および並び替え機能を提供します。

### 後方互換性

**旧ページ:** `/tasklists/[id].tsx` → `/app` へリダイレクト

既存のブックマークやリンク（例：`/tasklists/list-id`）の互換性を保つため、自動的に `/app` にリダイレクトされます。ユーザーは統合されたドロワーレイアウトで同じタスク管理機能を利用できます。

### 主要機能

#### 1. タスク一覧表示

**仕様:**

- タスクリスト内のすべてのタスクをリスト形式で表示
- 各タスクアイテムは以下の情報を含む：
  - ドラッグハンドル（≡アイコン）：タスクの並び替えに使用
  - チェックボックス：完了状態の切り替え
  - タスク内容テキスト：クリックして編集モードに切り替え
  - 削除ボタン：タスクを削除
- 完了したタスクは取り消し線で表示される

**エラーハンドリング:**

- 認証されていないユーザーはリダイレクト処理により、`/` へ移動

#### 2. タスクの並び替え（ドラッグ&ドロップ）

**機能:**

各タスクアイテムの左側にあるドラッグハンドル（≡アイコン）をドラッグして、タスクの順序を変更できます。

**ユーザー操作:**

1. ドラッグハンドルをマウスで押下（ポインタ感度: 8px）
2. マウスを上下に移動してタスクの順序を変更
3. マウスボタンを放すと新しい順序が保存される

**キーボード操作:**

- `arrow-up/down` キーでもドラッグハンドルをフォーカス後に順序変更が可能（アクセシビリティ対応）

**処理フロー:**

```
1. ユーザーがドラッグハンドルをドラッグ開始
   ↓
2. ドラッグ中はタスクが半透明表示
   ↓
3. ドラッグ終了時にドラッグされたタスクと対象タスクを特定
   ↓
4. 配列からドラッグ対象を一度除外し、対象タスク位置に挿入
   ↓
5. 1 からの連番で order を再採番
   ↓
6. `updateTasksOrder(taskListId, draggedTaskId, targetTaskId)` を呼び出し
   ↓
7. トランザクションで Firestore の `tasks[taskId].order` を一括更新
   ↓
8. ストアが更新され、自動的に画面に反映
```

**視覚的フィードバック:**

- ドラッグハンドルはホバー時に色が濃くなる（`hover:text-gray-600`）
- ドラッグ中のタスクは半透明表示（`opacity-50`）
- ドラッグハンドルは `cursor-grab` から `cursor-grabbing` に変更

**技術詳細:**

- ライブラリ: `@dnd-kit/core` と `@dnd-kit/sortable` を使用
- ポインタセンサーとキーボードセンサーの両方に対応
- 最も近い衝突検出アルゴリズムを使用（`closestCenter`）

#### 3. タスクの作成

**フォーム:**

- タスク入力フィールド：テキスト入力、履歴補完対応
- 追加ボタン：タスクを追加

**操作:**

1. 入力フィールドにタスク内容を入力
2. `Enter` キーを押すか「追加」ボタンをクリック
3. タスクがリストの最後に追加される

**履歴補完:**

- 入力フィールドは HTML の `datalist` を使用した補完機能を提供
- 過去に作成されたタスクテキストが候補として表示される
- リアルタイムでマッチしたテキストを候補リストから選択可能

**エラーハンドリング:**

- 空の入力は無効化（ボタンが disabled 状態）

#### 4. タスクの編集

**操作:**

1. タスク内容テキストをクリック
2. 編集モードに切り替わり、入力フィールドが表示される
3. テキストを編集
4. `Enter` キーで保存、`Escape` キーでキャンセル

#### 5. タスクの削除

**操作:**

1. タスクアイテムの削除ボタンをクリック
2. タスクが即座に削除される

#### 6. タスクの完了状態切り替え

**操作:**

1. チェックボックスをクリック
2. タスクの完了状態が切り替わる
3. 完了したタスクは取り消し線で表示される

#### 7. タスクリスト情報の編集

**リスト名の編集:**

1. リスト名をクリック
2. 編集モードに切り替わる
3. テキストを編集
4. `Enter` キーで保存、`Escape` キーでキャンセル

**リストの背景色変更:**

1. 「色を変更」ボタンをクリック
2. カラーピッカーモーダルが表示される
3. 色を選択して保存

#### 8. タスクリストの削除

**操作:**

1. 「リストを削除」ボタンをクリック
2. 確認モーダルが表示される
3. 削除を確認するとタスクリストとすべてのタスクが削除される

#### 9. タスクリストの共有

**機能:**

このタスクリストを他の人と共有できます。認証不要でshareCodeを使用して、誰でもタスクの閲覧・編集が可能です。shareCode は `shareCodes` コレクションで予約し、一意性を担保しています。

**操作:**

1. 「共有」ボタンをクリック
2. 共有モーダルが表示される
3. 「共有コードを生成」ボタンをクリックして共有コードを生成
4. 生成されたコードをコピーするか、共有URLをコピーして相手に送信
5. 共有を停止するには「共有を停止」ボタンをクリック

**共有コードの仕様:**

- 英数大文字のみで8文字
- ユニーク性を確保するためにFirestoreで検証
- 複数回生成することで異なるコードを取得可能
- 共有を停止するとコードは無効化される

### 状態管理

メインコンテンツエリアの状態は、親の app.tsx コンポーネントで一元管理されます。詳細は上記の「状態管理」セクションを参照してください。

主な状態変数：

- `editingTaskId`: 編集中のタスク ID
- `editingTaskText`: 編集中のテキスト
- `newTaskText`: 新規タスク入力テキスト
- `showDeleteConfirm`: 削除確認モーダルの表示状態
- `showEditColorModal`: 色編集モーダルの表示状態
- `showShareModal`: 共有モーダルの表示状態

### API インターフェース

#### addTask(taskListId: string, text: string, date?: string): Promise<string>

タスクを追加します。

**パラメータ:**

- `taskListId`: タスクリスト ID（必須）
- `text`: タスク内容（必須）
- `date`: タスクの日付（オプション）

**戻り値:**

- 作成されたタスク ID

**動作:**

1. 新しいタスク ID を生成
2. 既存タスクを order 昇順に並べ、挿入位置に新タスクを挿入
3. 全タスクを 1.0 から連番で再採番
4. トランザクション内で以下を実行：
   - Firestore にタスクを保存
   - order の一括更新
   - history フィールドを更新（重複排除、最大300件保持）
5. `updatedAt` タイムスタンプを設定

**history 管理:**

- タスク作成時にテキストが既に history に存在しない場合のみ追加
- 新しいテキストは history の先頭に挿入（新しい順）
- history の件数が300を超えた場合、最古のテキストを削除
- 重複なし：同じテキストは複数回登録されない

#### updateTask(taskListId: string, taskId: string, updates: Partial<Task>): Promise<void>

タスクを更新します。

**パラメータ:**

- `taskListId`: タスクリスト ID
- `taskId`: タスク ID
- `updates`: 更新する内容（テキスト、完了状態など）

#### deleteTask(taskListId: string, taskId: string): Promise<void>

タスクを削除します。

**パラメータ:**

- `taskListId`: タスクリスト ID
- `taskId`: タスク ID

#### updateTasksOrder(taskListId: string, draggedTaskId: string, targetTaskId: string): Promise<void>

タスクの順序を更新します（ドラッグ&ドロップ時）。

**パラメータ:**

- `taskListId`: タスクリスト ID
- `draggedTaskId`: ドラッグされたタスク ID
- `targetTaskId`: ドロップ先のタスク ID（この位置に移動）

**例:**

```typescript
await updateTasksOrder(taskListId, "task-1", "task-3");
// task-1 が task-3 の位置に移動（task-3 より下へ移動する場合は直後に配置）
```

**動作:**

1. 現在の order を昇順で取得し、ドラッグ対象を配列から除外
2. 対象タスクの位置に挿入し（上方向は直前、下方向は直後）、全タスクを 1.0 から連番で再採番
3. トランザクションを使用して Firestore の `tasks[taskId].order` を一括更新
4. `updatedAt` タイムスタンプを自動設定
5. ストアの変更をリスナーに通知

**技術仕様：**

- **order フィールド:** 1.0 からの連番
- **更新件数:** 並び替え後の全タスクに対して order を再採番
- **トランザクション処理:** 並行更新時の安全性を確保

#### removeAllCompletedTasks(taskListId: string): Promise<void>

タスクリスト内の完了タスクを一括削除します。

**パラメータ:**

- `taskListId`: タスクリスト ID

**動作:**

1. タスクリストを取得し、完了済みタスクの ID を抽出
2. 完了済みタスクをまとめて削除
3. 残ったタスクの order を `1.0` から再採番
4. `updatedAt` を更新し、トランザクションで Firestore に反映

#### sortTasks(taskListId: string): Promise<void>

タスクを完了状態・日付・現在の order の優先度で並び替えます。

**パラメータ:**

- `taskListId`: タスクリスト ID

**優先順位:**

1. 未完了タスクを先頭、完了タスクを末尾
2. 日付が早いタスクを優先（未設定・不正な日付は末尾）
3. 既存の order をタイブレークに使用

**動作:**

1. 上記の優先順位でタスクをソート
2. 並び替え後の順序に沿って order を `1.0` から再割り当て
3. `updatedAt` を更新し、トランザクションで Firestore に反映

### 翻訳キー

タスク詳細ページの UI テキストは i18next を使用して多言語対応されています。

**メッセージキー:**

```
taskList:
  taskCount: タスク数表示
  editColor: 色変更ボタンのテキスト
  addTask: 追加ボタンのテキスト
  addTaskPlaceholder: タスク入力フィールドのプレースホルダー
  selectColor: カラーピッカーのタイトル
  deleteList: リスト削除ボタンのテキスト
  deleteConfirm: 削除確認メッセージ
  dragHint: ドラッグハンドルのツールチップ
```

詳細は `locales/ja.json` および `locales/en.json` を参照してください。

### デザイン仕様

#### タスクアイテム

- **背景:** 白色（`bg-white`）
- **シャドウ:** 標準シャドウ（`shadow`）
- **コーナー:** 丸角（`rounded-lg`）
- **内部構造:**
  - ドラッグハンドル、チェックボックス、テキスト、削除ボタンが左から右へ配置
  - ドラッグハンドルは `cursor-grab`、ドラッグ中は `cursor-grabbing`
- **ホバー効果:**
  - シャドウ増加（`shadow-md`）
  - スムーズなトランジション（`transition-shadow`）
- **ドラッグ中:**
  - 半透明表示（`opacity-50`）

#### ドラッグハンドル

- **アイコン:** ≡ アイコン（6ドット）
- **色:** グレー（`text-gray-400`）
- **ホバー色:** より濃いグレー（`hover:text-gray-600`）
- **カーソル:** `cursor-grab` / `cursor-grabbing`

#### チェックボックス

- **スタイル:** 標準 HTML チェックボックス
- **サイズ:** `w-5 h-5`
- **色:** インディゴ（フォーカス時）

#### タスクテキスト

- **完了時:** 取り消し線（`line-through`）、グレー色（`text-gray-400`）
- **未完了:** 通常の色（`text-gray-800`）
- **ホバー:** 薄いグレー背景（`hover:bg-gray-100`）

#### 削除ボタン

- **背景:** 薄い赤（`bg-red-50`）
- **テキスト色:** 赤（`text-red-600`）
- **ホバー:** より濃い背景（`hover:bg-red-100`）

## 翻訳キー（タスクリスト一覧ページ）

タスクリスト一覧ページの UI テキストは i18next を使用して多言語対応されています。

**メッセージキー:**

```
app:
  dragHint: ドラッグハンドルのツールチップ
```

詳細は `locales/ja.json` および `locales/en.json` を参照してください。

## 共有ページ

**ページ:** `src/pages/sharecodes/[sharecode].tsx`

### 概要

shareCodeを使用して、認証なしでタスクリストを閲覧・編集できるページです。オーナーと同じUIでタスクの操作が可能であり、自分のリストに追加することもできます。

### 主要機能

#### 1. 共有リストの表示

**仕様:**

- URLのshareCodeパラメータから自動的にタスクリストを読み込む
- タスクの一覧をリスト形式で表示
- タスクリストの背景色を反映

**エラーハンドリング:**

- shareCodeが無効な場合はエラーメッセージを表示
- 読み込み中はローディング表示を表示

#### 2. タスク操作

**可能な操作:**

- タスク追加：新規タスク入力と「追加」ボタン
- タスク編集：テキストをクリックして編集モード
- タスク削除：削除ボタンをクリック
- 完了状態切り替え：チェックボックスをクリック
- タスク並び替え：ドラッグ&ドロップ

認証不要であり、誰でもこのリスト上のタスクを操作できます。

#### 3. 自分のリストに追加

**仕様:**

- ページ右上に「自分のリストに追加」ボタンを表示（ログイン済みユーザーのみ）
- クリックするとこのタスクリストが自分の`taskListOrder`に追加される
- 追加後、`/app`ページへリダイレクト

**エラーハンドリング:**

- 既に自分のリストに存在する場合はエラーメッセージを表示
- ログインしていない場合はボタンを表示しない

### 状態管理

**ページレベルの状態:**

```typescript
const [taskList, setTaskList] = useState<TaskListStore | null>(null);
const [loading, setLoading] = useState(true);
const [error, setError] = useState<string | null>(null);
const [user, setUser] = useState<typeof auth.currentUser>(null);
const [editingTaskId, setEditingTaskId] = useState<string | null>(null);
// ... その他のタスク編集状態
```

### API インターフェース

#### fetchTaskListByShareCode(shareCode: string): Promise<TaskListStore | null>

指定されたshareCodeでタスクリストを取得します。

**パラメータ:**

- `shareCode`: 共有コード（必須）

**戻り値:**

- TaskListStore オブジェクト、または見つからない場合は null

**動作:**

1. `shareCodes/{shareCode}` ドキュメントを取得し、紐づく `taskListId` を確認
2. 対応する `taskLists/{taskListId}` を取得して返却
3. shareCode が登録されていない場合は null を返す

#### addSharedTaskListToOrder(taskListId: string): Promise<void>

ログイン中のユーザーが共有されたタスクリストを自分のorderに追加します。

**パラメータ:**

- `taskListId`: タスクリスト ID（必須）

**動作:**

1. 現在のユーザーがログインしているか確認
2. 既に追加されているか確認
3. 新しい order 値を計算（最大order + 1.0）
4. `taskListOrder/{uid}` ドキュメントに追加
5. `/app` ページへリダイレクト

### 翻訳キー

共有ページの UI テキストは i18next を使用して多言語対応されています。

**メッセージキー:**

```
pages:
  sharecode:
    notFound: このタスクリストが見つかりません
    error: タスクリストを読み込めませんでした
    addTaskError: タスクを追加できませんでした
    updateError: タスクを更新できませんでした
    deleteError: タスクを削除できませんでした
    reorderError: タスクの順序を変更できませんでした
    addToOrderError: このタスクリストを追加できませんでした
    addToOrder: 自分のリストに追加
```

詳細は `locales/ja.json` および `locales/en.json` を参照してください。

### セキュリティ考慮事項

**現在の仕様:**

- 認証なしでタスクの閲覧・編集が可能
- shareCodeの推測は困難（8文字のランダム英数大文字）
- ただし、shareCodeが漏洩すると誰でもアクセス可能

**将来の改善:**

- Firestore セキュリティルールで shareCode の検証
- 一定時間でコードの自動失効機能
- アクセスログの記録機能

## Firestoreセキュリティルール

タスクリスト機能はFirestoreセキュリティルールによって保護されています。以下のルールが適用されます。

### 読み取り権限（Read）

認証済みユーザーが以下のいずれかを満たす場合にタスクリストを読み取り可能です：

1. **自分のtaskListOrderに登録されている場合**
   - ユーザーが作成したタスクリスト、または他者から共有されたタスクリストを自分のリストに追加した場合
   - ユーザーのtaskListOrderドキュメント内にtaskListIdが含まれている

2. **shareCodeが設定されている場合**
   - 認証済みユーザーは、shareCodeが設定されているタスクリストを読み取り可能
   - 共有コードを知っている他のユーザーによる閲覧を許可

### 書き込み権限（Update）

タスクリストの更新は、自分のtaskListOrderに登録されている場合のみ可能です：

- 不変フィールド（`id`、`createdAt`）の変更は防止
- shareCodeの変更は許可（共有機能のため）
- 共有されたタスクリストも、自分のtaskListOrderに追加済みなら編集可能

### 作成権限（Create）

認証済みユーザーであれば誰でもタスクリストを作成できます：

- 必須フィールド（`id`、`name`、`tasks`、`history`、`shareCode`、`background`、`createdAt`、`updatedAt`）の存在確認
- idがドキュメントのパスパラメータと一致することを確認
- createdAtとupdatedAtが整数型（ミリ秒タイムスタンプ）であることを確認

### 削除権限（Delete）

タスクリストの削除は、自分のtaskListOrderに登録されている場合のみ可能です：

- deleteBatchでtaskListOrderからも同時に削除される前提

### パフォーマンス考慮事項

- 各操作時にtaskListOrderドキュメントをget()関数で参照（1回の追加読み取り）
- ユーザーごとにtaskListOrderは1ドキュメントのみのため、コスト増は最小限

### 潜在的なリスク

認証済みユーザーは誰でもタスクリストを作成できるため、以下のような孤立ドキュメントが発生する可能性があります：

- taskListOrderに追加せずにtaskListのみを作成した場合
- 作成後は自分のtaskListOrderに含まれていないため、読み取り・更新・削除ができない
- 実質的に孤立したドキュメントとなり、ストレージを消費
- セキュリティ上の問題はない（アクセス不可のため）

## 今後の拡張機能

- カスタム背景色選択の拡張
- タスクのカテゴリ分類機能
- 優先度の設定機能
- タスクのフィルタリング・検索機能
- 共有コード有効期限設定機能
- 読み取り専用共有モード
